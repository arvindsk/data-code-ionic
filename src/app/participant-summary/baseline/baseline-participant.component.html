<p-confirmDialog header="Confirmation" icon="pi pi-exclamation-triangle" [key]="'baselinesubmit'" [baseZIndex]="10000"></p-confirmDialog>
<p-sidebar [(visible)]="flyout"
           position="right"
           [showCloseIcon]="true"
           [dismissible]="true"
           [closeOnEscape]="true"
           [baseZIndex]="99999"
           appendTo="body"
           styleClass="p-sidebar-md">

  <div class="custom-container">
    <mat-card>
      <mat-card-content>
        <div *ngIf="loadingData; else content">

          <div class="spinner__loading">
            <div>
              <mat-spinner>
              </mat-spinner>
              <h3>Sending Email.Please wait...</h3>
            </div>
          </div>
        </div>

        <ng-template #content>
          <div class="jumbotron">
            <div class="pmessagestyle">
              <p-messages [key]="'emailMessageError'" [hideTransitionOptions]="'10ms'" ></p-messages>
            </div>
            <div *ngIf="!resendClicked" class="container">
              <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">

                <div class="row">
                  <div class="form-group">
                    <label>Please Enter Participant Email ID</label>
                    <div class="input-group mb-3">
                      <input type="text" formControlName="email" class="form-control" aria-describedby="button-addon2" [ngClass]="{ 'is-invalid': submitted && f.email.errors }">
                      <button class="btn btn-secondary" type="button" (click)="clearField()" id="button-addon2"><em class="bi bi-x"></em></button>
                      <div *ngIf="submitted && f.email.errors" class="invalid-feedback">
                        <div *ngIf="f.email.errors.required">Email is required</div>
                        <div *ngIf="f.email.errors.email">Please enter valid email address</div>
                      </div>
                    </div>
                  </div>
                </div>
                <hr>
                <div class="row justify-content-between">
                  <div class="col-3">
                    <button type="button" (click)="onSubmit()" class="btn btn-primary button-background">Send
                    </button>

                  </div>
                  <div class="col-3">
                    <button type="button" (click)="flyout = false" class="btn btn-primary button-background">Cancel</button>
                  </div>

                </div>
              </form>

            </div>
            <div *ngIf="resendClicked" class="container">
              <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">

                <div class="row">
                  <div *ngIf="!editEmailbuttonClicked">
                    <h3>Questionnaire already emailed, would you like to resend? Please confirm</h3>
                    <button class="btn btn-outline-primary" type="button" (click)="editEmailClicked()" id="edit-button">Edit Email Address</button>
                  </div>

                  <div *ngIf="editEmailbuttonClicked" class="form-group">
                    <label>Please Enter Participant Email ID</label>
                    <div class="input-group mb-3">
                      <input type="text" formControlName="email" class="form-control" aria-describedby="button-addon3" [ngClass]="{ 'is-invalid': submitted && f.email.errors }">
                      <button class="btn btn-secondary" type="button" (click)="clearField()" id="button-addon3"><em class="bi bi-x"></em></button>
                      <div *ngIf="submitted && f.email.errors" class="invalid-feedback">
                        <div *ngIf="f.email.errors.required">Email is required</div>
                        <div *ngIf="f.email.errors.email">Please enter valid email address</div>
                      </div>
                    </div>
                  </div>
                </div>
                <hr>
                <div class="row justify-content-between">
                  <div *ngIf="resendClicked && editEmailbuttonClicked" class="col-3">
                    <button type="button" (click)="onSubmit()" class="btn btn-primary button-background">Send
                    </button>

                  </div>
                  <div *ngIf="!resendClicked && !editEmailbuttonClicked" class="col-3">
                    <button type="button" (click)="onSubmit()" class="btn btn-primary button-background">Send
                    </button>

                  </div>

                  <div *ngIf="resendClicked && !editEmailbuttonClicked" class="col-3">
                    <button type="button" (click)="onSubmit()" class="btn btn-primary button-background">Yes
                    </button>

                  </div>

                  <div class="col-3">
                    <button type="button" (click)="flyout = false;editEmailbuttonClicked=false;resendClicked=false" class="btn btn-primary button-background">Cancel</button>
                  </div>

                </div>
              </form>

            </div>
          </div>
        </ng-template>

      </mat-card-content>
    </mat-card>

  </div>
</p-sidebar>

<ion-content>
  <div class="aligncenter row justify-content-center">
    <div class="pmessagestyle">
      <p-messages [key]="'baselineAccessMessage'" [hideTransitionOptions]="'10ms'" ></p-messages>
    </div>
    <!--<p-toast position="top-right" [baseZIndex]="50000"></p-toast>-->
    <div class="col-md-8">

      <mat-card-title class="heading"><h1>{{headerName}} [Participant ID:{{headerId}}]</h1></mat-card-title>
      <p class="alignpage"></p>
      <mat-table mat-table [dataSource]="tableValues" [class.isMobile]="isMobile" class="mat-elevation-z8">

        <!--- Note that these columns can be defined in any order.
              The actual rendered columns are set as a property on the row definition" -->

        <!-- Position Column -->
        <ng-container matColumnDef="studyName">
          <mat-header-cell mat-header-cell *matHeaderCellDef> Questionnaire</mat-header-cell>
          <mat-cell mat-cell *matCellDef="let element">
            <span class="mobile-label">Questionnaire:</span>{{element.studyName}}
            <!--        <mat-icon *ngIf="element.studyName==='Physical Activity Screening'" [inline]="true" (click)="openModel()" matTooltip="Instructions">
                      <ion-icon size="small" name="information-circle">
                      </ion-icon>
                    </mat-icon>-->
          </mat-cell>
        </ng-container>

        <ng-container matColumnDef="access">
          <mat-header-cell mat-header-cell *matHeaderCellDef> Access</mat-header-cell>
          <mat-cell mat-cell *matCellDef="let element">
            <span class="mobile-label">Access:</span>
            <span>
              <mat-form-field>

                <mat-select  [(ngModel)]="element.access" (ngModelChange)="onDropdownValueChange(element)">
                      <mat-option *ngFor="let access of acccessMode" [value]="access.code">   {{ access.name }} </mat-option>
                </mat-select>
              </mat-form-field>
            </span>
          </mat-cell>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="status">
          <mat-header-cell mat-header-cell *matHeaderCellDef> Status</mat-header-cell>
          <mat-cell mat-cell *matCellDef="let element">
            <span class="mobile-label">Status:</span>
            <span *ngIf="element.status=='Email-In-Progress'">In-Progress</span>
            <span *ngIf=" element.status !='Email-In-Progress' && (element.activeTimeline=='Baseline' || element.status=='Submitted') ">{{element.status}}</span>
            <span *ngIf="element.status !='Email-In-Progress' && element.activeTimeline!='Baseline' && element.status!='Submitted'">Not Attempted</span>
          </mat-cell>
        </ng-container>

        <!-- Weight Column -->
        <ng-container matColumnDef="start">
          <mat-header-cell mat-header-cell *matHeaderCellDef> Activity</mat-header-cell>
          <mat-cell mat-cell *matCellDef="let element">
            <span class="mobile-label">Activity:</span>
            <span *ngIf="element.status=='Not Started' && element.activeTimeline=='Baseline' && element.access !='email'">
              <a href="javascript:void(0)" (click)="onTab(element)">Begin</a>
            </span>
            <span *ngIf="element.status=='Not Started' && element.activeTimeline=='Baseline' && element.access =='email'">
              <a href="javascript:void(0)" (click)="flyout=true;updateStudy(element)">Begin</a>
            </span>
            <span *ngIf="element.status=='In-Progress' && element.activeTimeline=='Baseline' && element.access!=='email' ">
              <a href="javascript:void(0)" (click)="onTab(element)">Continue</a>
            </span>
            <span *ngIf="element.status=='In-Progress' && element.activeTimeline=='Baseline' && element.access=='email' ">
              Continue
            </span>
            <span *ngIf="element.status=='Submitted' && element.access=='coordinator'">
              <a href="javascript:void(0)" (click)="onTab(element)">View</a>
            </span>
            <span *ngIf="element.status=='Submitted' && element.access !='coordinator'">
              View
            </span>
            <span *ngIf="element.status!='Submitted' && element.activeTimeline!='Baseline'">Begin</span>
            <span *ngIf="element.status=='Ready for Submission' && element.activeTimeline=='Baseline' && element.access=='coordinator'" >
              <a href="javascript:void(0)" (click)="onTab(element)">Submit</a>
            </span>
            <span *ngIf="element.status=='Ready for Submission' && element.activeTimeline=='Baseline' && element.access !=='coordinator'" >
            Submit
            </span>
            <span *ngIf="element.status=='Email-In-Progress' && element.activeTimeline=='Baseline' && element.access=='email'">
             <a href="javascript:void(0)" (click)="flyout=true;updateStudy(element)">Begin</a>
            </span>
            <span *ngIf="element.status=='Send Email' && element.activeTimeline=='Baseline' && element.status !=='In-Progress'">
              <a href="javascript:void(0)" (click)="flyout=true;resendQuestionnaire(element)">Emailed</a>
            </span>
          </mat-cell>
        </ng-container>

        <!-- Symbol Column -->
        <ng-container matColumnDef="completedDate">
          <mat-header-cell mat-header-cell *matHeaderCellDef> Completed Date</mat-header-cell>
          <mat-cell mat-cell *matCellDef="let element">
            <span class="mobile-label">Completed Date:</span>{{element.completedDate | date}} </mat-cell>
        </ng-container>

        <mat-header-row mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
      </mat-table>
    </div>

  </div>

  <ng-template #modalContent let-modal>
    <div class="modal-header">
      <h3 class="modal-title" id="modal-basic-title">Physical activity instructions</h3>
      <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
        <span aria-hidden="true">&times;</span>
      </button>

    </div>
    <div class="modal-body" style="font-size: small">
      <div>
        <img src="assets/exercise_intro.JPG">
      </div>
    </div>
  </ng-template>
</ion-content>
